tinymce.PluginManager.add("link",function(t){function e(t){return t&&"A"===t.nodeName&&t.href}function n(t){return tinymce.util.Tools.grep(t,e).length>0}function i(e){return t.dom.getParent(e,"a[href]")}function a(){return i(t.selection.getStart())}function l(t){var e=t.getAttribute("data-mce-href");return e||t.getAttribute("href")}function r(){var e=t.plugins.contextmenu;return!!e&&e.isContextMenuVisible()}function o(t,e){document.body.appendChild(t),t.dispatchEvent(e),document.body.removeChild(t)}function s(t){if(!tinymce.Env.ie||tinymce.Env.ie>10){var e=document.createElement("a");e.target="_blank",e.href=t,e.rel="noreferrer noopener";var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o(e,n)}else{var i=window.open("","_blank");if(i){i.opener=null;var a=i.document;a.open(),a.write('<meta http-equiv="refresh" content="0; url='+tinymce.DOM.encode(t)+'">'),a.close()}}}function u(e){if(e){var n=l(e);if(/^#/.test(n)){var i=t.$(n);i.length&&t.selection.scrollIntoView(i[0],!0)}else s(e.href)}}function c(){u(a())}function f(e){return function(){var n=t.settings.link_list;"string"==typeof n?tinymce.util.XHR.send({url:n,success:function(t){e(tinymce.util.JSON.parse(t))}}):"function"==typeof n?n(e):e(n)}}function d(t,e,n){function i(t,n){return n=n||[],tinymce.each(t,function(t){var a={text:t.text||t.title};t.menu?a.menu=i(t.menu):(a.value=t.value,e&&e(a)),n.push(a)}),n}return i(t,n||[])}function g(e){function n(t){var e=o.find("#text");(!e.value()||t.lastControl&&e.value()==t.lastControl.text())&&e.value(t.control.text()),o.find("#href").value(t.control.value())}function i(){!r&&0===p.text.length&&s&&this.parent().parent().find("#text")[0].value(this.value())}var a,l,r,o,s,u,c,f,g,v,m,x,p={},k=t.selection,y=t.dom;a=k.getNode(),l=y.getParent(a,"a[href]"),s=function(t){var e=k.getContent();if(/</.test(e)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(e)||-1==e.indexOf("href=")))return!1;if(t){var n,i=t.childNodes;if(0===i.length)return!1;for(n=i.length-1;n>=0;n--)if(3!=i[n].nodeType)return!1}return!0}(),p.text=r=l?l.innerText||l.textContent:k.getContent({format:"text"}),p.href=l?y.getAttrib(l,"href"):"",l?p.target=y.getAttrib(l,"target"):t.settings.default_link_target&&(p.target=t.settings.default_link_target),(x=y.getAttrib(l,"rel"))&&(p.rel=x),(x=y.getAttrib(l,"class"))&&(p.class=x),(x=y.getAttrib(l,"title"))&&(p.title=x),s&&(u={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){p.text=this.value()}}),e&&(c={type:"listbox",label:"Link list",values:d(e,function(e){e.value=t.convertURL(e.value||e.url,"href")},[{text:"None",value:""}]),onselect:n,value:t.convertURL(p.href,"href"),onPostRender:function(){c=this}}),!1!==t.settings.target_list&&(t.settings.target_list||(t.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),g={name:"target",type:"listbox",label:"Target",values:d(t.settings.target_list)}),t.settings.rel_list&&(f={name:"rel",type:"listbox",label:"Rel",values:d(t.settings.rel_list)}),t.settings.link_class_list&&(v={name:"class",type:"listbox",label:"Class",values:d(t.settings.link_class_list,function(e){e.value&&(e.textStyle=function(){return t.formatter.getCssText({inline:"a",classes:[e.value]})})})}),!1!==t.settings.link_title&&(m={name:"title",type:"textbox",label:"Title",value:p.title}),o=t.windowManager.open({title:"Insert link",data:p,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:function(e){var n=e.meta||{};c&&c.value(t.convertURL(this.value(),"href")),tinymce.each(e.meta,function(t,e){var n=o.find("#"+e);"text"===e?0===r.length&&(n.value(t),p.text=t):n.value(t)}),n.attach&&(h={href:this.value(),attach:n.attach}),n.text||i.call(this)},onkeyup:i,onbeforecall:function(t){t.meta=o.toJSON()}},u,m,function(e){var i=[];if(tinymce.each(t.dom.select("a:not([href])"),function(t){var n=t.name||t.id;n&&i.push({text:n,value:"#"+n,selected:-1!=e.indexOf("#"+n)})}),i.length)return i.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:i,onselect:n}}(p.href),c,f,g,v],onSubmit:function(e){function n(e,n){var i=t.selection.getRng();tinymce.util.Delay.setEditorTimeout(t,function(){t.windowManager.confirm(e,function(e){t.selection.setRng(i),n(e)})})}function i(t,e){function n(t){var e=new RegExp("("+i.replace(" ","|")+")","g");return t&&(t=tinymce.trim(t.replace(e,""))),t||null}var i="noopener noreferrer";return e?function(t){return(t=n(t))?[t,i].join(" "):i}(t):n(t)}function a(){var e={href:u,target:p.target?p.target:null,rel:p.rel?p.rel:null,class:p.class?p.class:null,title:p.title?p.title:null};t.settings.allow_unsafe_link_target||(e.rel=i(e.rel,"_blank"==e.target)),u===h.href&&(h.attach(),h={}),l?(t.focus(),s&&p.text!=r&&("innerText"in l?l.innerText=p.text:l.textContent=p.text),y.setAttribs(l,e),k.select(l),t.undoManager.add()):s?t.insertContent(y.createHTML("a",e,y.encode(p.text))):t.execCommand("mceInsertLink",!1,e)}function o(){t.undoManager.transact(a)}var u;p=tinymce.extend(p,e.data),(u=p.href)?u.indexOf("@")>0&&-1==u.indexOf("//")&&-1==u.indexOf("mailto:")?n("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(t){t&&(u="mailto:"+u),o()}):t.settings.link_assume_external_targets&&!/^\w+:/i.test(u)||!t.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(u)?n("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(t){t&&(u="http://"+u),o()}):o():t.execCommand("unlink")}})}var h={},v=function(t){return!0===t.altKey&&!1===t.shiftKey&&!1===t.ctrlKey&&!1===t.metaKey};t.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:f(g),stateSelector:"a[href]"}),t.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),t.addContextToolbar&&(t.addButton("openlink",{icon:"newtab",tooltip:"Open link",onclick:c}),t.addContextToolbar(function(n){var i,a,l;return!!(t.settings.link_context_toolbar&&!r()&&e(n)&&(i=t.selection,a=i.getRng(),3==(l=a.startContainer).nodeType&&i.isCollapsed()&&a.startOffset>0&&a.startOffset<l.data.length))},"openlink | link unlink")),t.addShortcut("Meta+K","",f(g)),t.addCommand("mceLink",f(g)),t.on("click",function(t){var e=i(t.target);e&&tinymce.util.VK.metaKeyPressed(t)&&(t.preventDefault(),u(e))}),t.on("keydown",function(t){var e=a();e&&13===t.keyCode&&v(t)&&(t.preventDefault(),u(e))}),this.showDialog=g,t.addMenuItem("openlink",{text:"Open link",icon:"newtab",onclick:c,onPostRender:function(){var e=this,i=function(t){n(t.parents)?e.show():e.hide()};n(t.dom.getParents(t.selection.getStart()))||e.hide(),t.on("nodechange",i),e.on("remove",function(){t.off("nodechange",i)})},prependToContext:!0}),t.addMenuItem("link",{icon:"link",text:"Link",shortcut:"Meta+K",onclick:f(g),stateSelector:"a[href]",context:"insert",prependToContext:!0})});